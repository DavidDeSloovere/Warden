"use strict";var app=function(){function e(e){$("nav,#nav-mobile").find("li").removeClass("active");var t=$("nav,#nav-mobile").find('a[href^="'+e+'"]');t.parent().addClass("active"),t.parent().parent().parent().addClass("active")}function t(){$("[data-block]").on("submit",function(e){$(this).validate();var t=$(this).valid();if(t){var o=$(document).find("[type=submit]");o.addClass("disabled"),o.attr("readonly","readonly"),o.prop("disabled",!0)}})}function o(){$("input[type=checkbox]").each(function(){var e="True"===$(this).data("checked");e&&($(this).prop("checked",!0),$(this).val(!0))}),$("input[type=checkbox]").click(function(){$(this).val($(this).is(":checked"))})}function a(){function e(e){window.prompt("Copy to clipboard: Ctrl+C, Enter",e)}$("[data-clipboard]").click(function(){e($(this).data("clipboard"))})}function n(){$(".modal-trigger").leanModal(),$("[data-remove-api-key]").click(function(){$("#api-key-to-delete").val($(this).data("api-key"))}),$("[data-remove-user-from-organization]").click(function(){$("#user-id-to-delete").val($(this).data("user-id"))}),$("[data-remove-warden-from-organization]").click(function(){$("#warden-id-to-delete").val($(this).data("warden-id"))})}var r="",i="",s="",l=function(l){r=l.loginPath||"/login",i=l.logoutPath||"/logout",s=l.url||"/";var c="/"+s.split("/")[1];e(c),t(),o(),n(),a(),$(".tooltipped").tooltip({delay:50}),$(".button-collapse").sideNav()};return{init:l}}(),dashboard=function(){function e(){function e(e){W.totalUptime(e.totalUptime),W.totalDowntime(e.totalDowntime),W.totalValidIterations(e.totalValidIterations),W.totalInvalidIterations(e.totalInvalidIterations),W.failingResources([]),e.watchers.forEach(function(e){var t=new r(e);W.failingResources.push(t)}),W.failingResources.sort(function(e,t){return e.totalDowntime()<t.totalDowntime()})}function n(e){var t=e.results.filter(function(e){return e.isValid});W.validResources(t.length),W.invalidResources(e.results.length)}function u(){W.organizations.remove(function(e){return""===e.name()});var e=W.organizations().filter(function(e){return e.id()===f})[0],t=e.wardens().filter(function(e){return e.name()===b})[0];W.selectedOrganization(e),W.selectedWarden(t)}function d(){s().then(function(t){e(t)})}function h(e){if(W.shouldUpdateIterationsChart()){var t=W.iterations().length>=10;y(e,t)}A(e)}function v(){$("#loader").addClass("hide"),$("#dashboard").removeClass("hide")}function k(){var e={labels:[],datasets:[{label:"Warden",fillColor:I.colors.green,strokeColor:I.colors.grey,pointColor:I.colors.grey,pointStrokeColor:I.colors.white,pointHighlightFill:I.colors.white,pointHighlightStroke:I.colors.grey,data:[0]}]},t={responsive:!0};x=new Chart(V).Line(e,t)}function y(e,t){var o=e.results.filter(function(e){return e.isValid}),a=o.length,n=e.completedAt;t&&x.removeData(),x.addData([a],n)}function R(){var e=[],t=[];W.iterations().forEach(function(o){e.push(o.completedAt);var a=o.results.filter(function(e){return e.isValid});t.push(a.length)});var o={scaleOverride:!0,scaleSteps:m,scaleStepWidth:1,scaleStartValue:0,responsive:!0},a={labels:e,datasets:[{label:"Warden",fillColor:I.colors.green,strokeColor:I.colors.grey,pointColor:I.colors.grey,pointStrokeColor:I.colors.white,pointHighlightFill:I.colors.white,pointHighlightStroke:I.colors.grey,data:t}]};x=new Chart(V).Line(a,o),w.click(function(e){var t=x.getPointsAtEvent(e)[0],o=t.label,a=W.iterations().filter(function(e){return e.completedAt===o})[0],n="/organizations/"+f+"/wardens/"+g+"/iterations/"+a.id;window.open(n,"_blank")})}function z(){var e=[];e.push({value:1,color:I.colors.lightGrey,highlight:I.colors.lightGreyHighlight,label:"Missing data"});var t={responsive:!0};E=new Chart(D).Pie(e,t)}function A(e){if(W.shouldUpdateWatchersChart()){var t=e.results.filter(function(e){return!e.isValid}),o=e.results.filter(function(e){return e.isValid}),a=[],n=[];U=[],e.results.forEach(function(e){U.push(e),n.push(e.watcherCheckResult.watcherName)}),t.forEach(function(e){a.push({value:1,color:I.colors.red,highlight:I.colors.redHighlight,label:e.watcherCheckResult.watcherName})}),o.forEach(function(e){a.push({value:1,color:I.colors.green,highlight:I.colors.greenHighlight,label:e.watcherCheckResult.watcherName})});var r={responsive:!0};E=new Chart(D).Pie(a,r),C.click(function(e){var t=E.getSegmentsAtEvent(e)[0],o=t.label,a=U.filter(function(e){return e.watcherCheckResult.watcherName===o})[0];W.selectedWardenCheckResult(new i(a))})}}var W=this,U=[];w=$("#iterations-chart"),C=$("#watchers-chart");var V=w[0].getContext("2d"),D=C[0].getContext("2d"),x=null,E=null;W.shouldUpdateIterationsChart=ko.observable(!0),W.shouldUpdateWatchersChart=ko.observable(!0),W.toggleUpdateIterationsChart=function(){var e=W.shouldUpdateIterationsChart(),t="Iterations chart updates have been ";t+=e?"paused.":"resumed.",Materialize.toast(t,3e3,I.css.lightBlue),W.shouldUpdateIterationsChart(!e)},W.toggleUpdateWatchersChart=function(){var e=W.shouldUpdateWatchersChart(),t="Watchers chart updates have been ";t+=e?"paused.":"resumed.",Materialize.toast(t,3e3,I.css.lightBlue),W.shouldUpdateWatchersChart(!e)},W.organizations=ko.observableArray([t()]),W.selectedOrganization=ko.observable(),W.selectedWarden=ko.observable(),W.selectedOrganization.subscribe(function(e){}),W.selectedWarden.subscribe(function(e){$("select").material_select()}),W.totalUptime=ko.observable(0),W.totalUptimeFormatted=ko.computed(function(){return W.totalUptime().toFixed(2)+"%"}),W.totalDowntime=ko.observable(0),W.totalDowntimeFormatted=ko.computed(function(){return W.totalDowntime().toFixed(2)+"%"}),W.validResources=ko.observable(0),W.invalidResources=ko.observable(0),W.totalResourcesFormatted=ko.computed(function(){return W.validResources()+" of "+W.invalidResources()+" watcher(s) returned valid result(s)."}),W.latestCheckAt=ko.observable("---"),W.latestCheckAtFormatted=ko.computed(function(){return W.latestCheckAt()}),W.failingResources=ko.observableArray([]),W.mostFailingResources=ko.computed(function(){var e=W.failingResources().filter(function(e){return e.totalDowntime()>0});return e.slice(0,3)}),W.iterations=ko.observableArray([]),W.selectedWardenCheckResult=ko.observable(new i(o())),W.totalValidIterations=ko.observable(0),W.totalInvalidIterations=ko.observable(0),W.totalIterations=ko.computed(function(){return W.totalValidIterations()+W.totalInvalidIterations()}),W.totalIterationsFormatted=ko.computed(function(){var e=W.totalValidIterations(),t=W.totalInvalidIterations(),o=W.totalIterations();return o+" ("+e+" valid, "+t+" invalid)."}),W.setIterationDetails=function(e){W.latestCheckAt(e.completedAt),n(e),h(e)},W.changeWarden=function(){var e=W.selectedOrganization().id(),t=W.selectedWarden().id();window.location="/dashboards/organizations/"+e+"/wardens/"+t},d(),setInterval(d,1e3*p),c().then(function(e){e.forEach(function(e){W.organizations.push(new a(e))}),u(),$("select").material_select()}),l().then(function(e){if(0===e.length)return v(),k(),void z();var t=e[0];W.iterations(e),v(),R(),A(t),W.setIterationDetails(t)})}function t(){return new a({id:"",name:"",wardens:[]})}function o(){return{completedAt:"---",watcherCheckResult:{watcherName:"---",watcherType:"---",description:"---",isValid:"---"}}}function a(e){var t=this;t.id=ko.observable(e.id),t.name=ko.observable(e.name),t.wardens=ko.observableArray([]),e.wardens.forEach(function(e){t.wardens.push(new n(e))})}function n(e){var t=this;t.id=ko.observable(e.id),t.name=ko.observable(e.name),t.enabled=ko.observable(e.name)}function r(e){var t=this;t.name=ko.observable(e.name),t.type=ko.observable(e.type),t.totalDowntime=ko.observable(e.totalDowntime),t.totalUptime=ko.observable(e.totalUptime),t.url=ko.computed(function(){return"/organizations/"+f+"/wardens/"+g+"/watchers/"+t.name()}),t.infoFormatted=ko.computed(function(){return t.name()+" ("+t.totalDowntime().toFixed(2)+"%)"})}function i(e){function t(e){if(!e)return"";var o=t(e.innerException),a="";return o&&(a="<br><br><hr><strong>*Inner exception*</strong><br><br>"+o),"<strong>Source:</strong><br>"+e.source+"<br><br><strong>Message:</strong><br>"+e.message+"<br><br><strong>Stack trace:</strong><br>"+e.stackTraceString+a}var o=this;o.watcherName=ko.observable(e.watcherCheckResult.watcherName),o.watcherType=ko.observable(e.watcherCheckResult.watcherType),o.isValid=ko.observable(e.watcherCheckResult.isValid),o.description=ko.observable(e.watcherCheckResult.description),o.completedAt=ko.observable(e.completedAt),o.exception=ko.observable(e.exception),o.url=ko.computed(function(){return"/organizations/"+f+"/wardens/"+g+"/watchers/"+o.watcherName()}),o.exceptionFormatted=ko.computed(function(){return o.exception()?t(o.exception()):"---"})}function s(){var e=f+"/wardens/"+b+"/stats";return u(e)}function l(){var e=f+"/wardens/"+b+"/iterations";return u(e,{results:10})}function c(){return u()}function u(e,t){return $.ajax({url:"/api/organizations/"+(e||""),headers:{"X-Api-Key":v},method:"GET",data:t,success:function(e){return e}})}function d(){function e(){Materialize.toast("Connecting to the Warden Hub.",3e3,I.css.lightBlue),$.connection.hub.start().done(function(){Materialize.toast("Connection has been established.",3e3,I.css.lightGreen)}).fail(function(){Materialize.toast("Connection could not have been established.",3e3,I.css.lightRed)})}$.connection.hub.qs={organizationId:f,wardenName:b};var t=$.connection.wardenHub;t.client.iterationCreated=function(e){e=h(e),k.setIterationDetails(e),k.iterations.push(e),e.isValid?k.totalValidIterations(k.totalValidIterations()+1):k.totalInvalidIterations(k.totalInvalidIterations()+1)},e(),$.connection.hub.disconnected(function(){var t="";$.connection.hub.lastError&&(t=" Reason: "+$.connection.hub.lastError.message),Materialize.toast("Connection has been lost, reconnecting in 3 seconds."+t,3e3,I.css.lightRed),setTimeout(e,3e3)}),$.connection.hub.reconnected(function(){Materialize.toast("Reconnection has succeeded.",3e3,I.css.lightGreen)})}function h(e){var t,o,a,n;if(e instanceof Array){t=[];for(o in e)n=e[o],"object"==typeof n&&(n=h(n)),t.push(n)}else{t={};for(o in e)e.hasOwnProperty(o)&&(a=(o.charAt(0).toLowerCase()+o.slice(1)||o).toString(),n=e[o],null!==n&&"object"==typeof n&&(n=h(n)),t[a]=n)}return t}var f="",b="",g="",v="",p=0,m=0,k=null,w=null,C=null,I={colors:{green:"rgba(91, 187, 22, 0.2)",greenHighlight:"rgba(91, 187, 22, 0.5)",red:"rgba(247, 70, 74, 0.5)",redHighlight:"rgba(247, 70, 74, 0.8)",grey:"rgba(220,220,220,1)",lightGrey:"rgba(75, 74, 73, 0.1)",lightGreyHighlight:"rgba(75, 74, 73, 0.2)",white:"#fff"},css:{lightBlue:"blue lighten-1",lightGreen:"green lighten-1",lightRed:"red lighten-1"}},y=function(t){f=t.organizationId||"",b=t.wardenName||"",g=t.wardenId||"",v=t.apiKey||"",m=t.totalWatchers||0,p=t.refreshStatsIntervalSeconds||60,k=new e,ko.applyBindings(k),d()};return{init:y}}();